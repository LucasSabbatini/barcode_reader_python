FROM siliconlife/python_base

# open-cv
RUN apt-get update -y && \
    apt-get remove x264 libx264-dev && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends  gcc \
                                                g++ \
                                                gfortran \
                                                build-essential \
                                                software-properties-common \
                                                python3 \
                                                python3-pip \
                                                python3-dev \
                                                python3-setuptools \
                                                libhdf5-dev \
                                                libhdf5-serial-dev \
                                                libblas3 \
                                                libblas-dev \
                                                liblapack3 \
                                                liblapack-dev \
                                                libgfortran3 \
                                                libatlas-base-dev \
                                                libjpeg8-dev \
                                                libjasper-dev \
                                                libpng12-dev \
                                                libtiff5-dev \
                                                zlib1g-dev \
                                                freetype* \
                                                libtiff-dev \
                                                libjpeg-dev \
                                                libpng-dev \

# OpenCV
RUN apt-get install -y --no-install-recommends \
                                                checkinstall \
                                                cmake \
                                                pkg-config \
                                                yasm \
                                                pkg-config \
                                                git \
                                                libgtk2.0-dev \
                                                libeigen3-dev \
                                                libtheora-dev \
                                                libvorbis-dev \
                                                libxvidcore-dev \
                                                libx264-dev \
                                                sphinx-common \
                                                libfaac-dev \
                                                libopencore-amrnb-dev \
                                                libopencore-amrwb-dev \
                                                libopenexr-dev \
                                                libgstreamer1.0-0 \
                                                libgstreamer-plugins-base1.0-dev \
                                                libavutil-dev \
                                                libavfilter-dev \
                                                libavresample-dev \
                                                libtbb2 \
                                                libtbb-dev \
                                                python-dev \
                                                python-numpy \
                                                pylint \
                                                libavcodec-dev \
                                                libavformat-dev \
                                                libswscale-dev \
                                                libdc1394-22-dev \
                                                libeigen3-dev \
                                                ffmpeg \
                                                libxine2-dev \
                                                libv4l-dev \
                                                gstreamer1.0-plugins-base \
                                                gstreamer1.0-plugins-good \
                                                gstreamer1.0-plugins-bad \
                                                gstreamer1.0-plugins-ugly \
                                                gstreamer1.0-libav \
                                                gstreamer1.0-doc \
                                                gstreamer1.0-tools \
                                                libxvidcore-dev \
                                                libx264-dev \
                                                qt5-default \
                                                libmp3lame-dev \
                                                x264 \
                                                v4l-utils

WORKDIR /usr
RUN git clone https://github.com/opencv/opencv.git

WORKDIR /usr/opencv
RUN mkdir build
WORKDIR /usr/opencv/build

RUN cmake -D CMAKE_BUILD_TYPE=RELEASE \
            -D CMAKE_INSTALL_PREFIX=/usr/local \
            -D WITH_TBB=ON \
            -D WITH_V4L=ON \
            -D WITH_QT=ON \
            -D WITH_OPENGL=ON \
            -D WITH_FFMPEG=ON \
            -D WITH_CUBLAS=ON \
            -D WITH_CUDA=ON \
            -D CUDA_ARCH_BIN="6.2" \
            -D CUDA_ARCH_PTX="" \
            -D WITH_LIBV4L=ON \
            -D CUDA_FAST_MATH=ON \
            -D BUILD_TESTS=OFF \
            -D BUILD_PERF_TESTS=OFF \
            -D BUILD_EXAMPLES=OFF \
            -D CUDA_NVCC_FLAGS="-D_FORCE_INLINES" ..

RUN ln -s /usr/include/libv4l1-videodev.h /usr/include/linux/videodev.h
RUN make -j8
RUN make install
RUN sh -c 'echo "/usr/local/lib" >> /etc/ld.so.conf.d/opencv.conf'
RUN ldconfig

RUN rm -rf /usr/opencv
